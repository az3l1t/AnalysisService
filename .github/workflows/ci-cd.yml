name: CI/CD Pipeline (GitHub Container Registry)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/medical-analysis-auth

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: auth_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        DATABASE_URL: sqlite:///./test.db
        SECRET_KEY: test-secret-key
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,format=long
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          type=ref,event=branch
          type=ref,event=pr
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: Output image info
      run: |
        echo "üì¶ Built images:"
        echo "${{ steps.meta.outputs.tags }}" | sed 's/,/\n/g' | sed 's/^/  - /'
        echo ""
        echo "üéØ Main image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Check DATABASE_URL
      run: |
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "‚ö†Ô∏è DATABASE_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–µ–ø–ª–æ–π –ø—Ä–æ–ø—É—â–µ–Ω."
          echo "üìã –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –¥–µ–ø–ª–æ–π, –¥–æ–±–∞–≤—å—Ç–µ DATABASE_URL:"
          echo "   gh secret set DATABASE_URL --repo ${{ github.repository }} --body 'postgresql+psycopg://user:password@host:5432/dbname'"
          echo "‚úÖ –û–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ GitHub Container Registry"
          echo "‚úÖ –î–µ–ø–ª–æ–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è DATABASE_URL"
          exit 0
        else
          echo "‚úÖ DATABASE_URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–µ–ø–ª–æ–π..."
        fi
    
    - name: Install dependencies
      if: secrets.DATABASE_URL != ''
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
    
    - name: Install Yandex Cloud CLI
      if: secrets.DATABASE_URL != ''
      run: |
        echo "üì¶ Installing Yandex Cloud CLI..."
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        yc version
    
    - name: Configure Yandex Cloud CLI
      if: secrets.DATABASE_URL != ''
      env:
        YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
        YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      run: |
        echo "üîê Configuring Yandex Cloud CLI..."
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å credentials
        echo "${{ secrets.YC_SA_JSON_CREDENTIALS }}" > $YC_SERVICE_ACCOUNT_KEY_FILE
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º YC CLI —Å service account key
        yc config profile create github-actions || true
        yc config set service-account-key $YC_SERVICE_ACCOUNT_KEY_FILE
        yc config set folder-id $YC_FOLDER_ID
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–±–µ–∑ –≤—ã–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞)
        yc config list | grep -v token
        
        echo "‚úÖ Yandex Cloud CLI configured"
    
    - name: Deploy to Yandex Cloud Run
      if: secrets.DATABASE_URL != ''
      env:
        REGISTRY: ${{ env.REGISTRY }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo "üöÄ Deploying to Yandex Cloud Run..."
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        yc serverless container create --name auth-service --folder-id ${{ secrets.YC_FOLDER_ID }} || echo "Container already exists"
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–≥ 'latest' –¥–ª—è main branch
        FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}:latest"
        echo "üì¶ Using image: ${FULL_IMAGE}"
        
        # –î–µ–ø–ª–æ–∏–º –Ω–æ–≤—É—é —Ä–µ–≤–∏–∑–∏—é —Å –æ–±—Ä–∞–∑–æ–º –∏–∑ GitHub Container Registry
        yc serverless container revision deploy \
          --container-name auth-service \
          --folder-id ${{ secrets.YC_FOLDER_ID }} \
          --image ${FULL_IMAGE} \
          --service-account-id ${{ secrets.YC_SERVICE_ACCOUNT_ID }} \
          --cores 1 \
          --memory 512MB \
          --execution-timeout 30s \
          --concurrency 10 \
          --environment \
            DATABASE_URL="${{ secrets.DATABASE_URL }}",\
            SECRET_KEY="${{ secrets.SECRET_KEY }}",\
            ALGORITHM="HS256",\
            ACCESS_TOKEN_EXPIRE_MINUTES="30" \
          --min-instances 1 \
          --max-instances 3
        
        echo "‚úÖ Deployment completed successfully!"
    
    - name: Get service URL
      if: secrets.DATABASE_URL != ''
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        SERVICE_URL=$(yc serverless container get --name auth-service --folder-id ${{ secrets.YC_FOLDER_ID }} --format json | jq -r '.url' || echo "URL not available")
        echo "üåê Service URL: $SERVICE_URL"
        if [ "$SERVICE_URL" != "null" ] && [ -n "$SERVICE_URL" ] && [ "$SERVICE_URL" != "URL not available" ]; then
          echo "‚úÖ Service deployed at: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "üåê Service URL: $SERVICE_URL"
        else
          echo "‚ö†Ô∏è Service URL not available yet. Check Cloud Run console."
        fi

