name: CI/CD Pipeline - Yandex Cloud Run

# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð² Yandex Cloud Run
# Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð² .github/workflows/ci-cd.yml Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: ${{ secrets.YC_REGISTRY_ID }}/medical-analysis-auth

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        DATABASE_URL: sqlite:///./test.db
        SECRET_KEY: test-secret-key
      run: |
        pytest tests/ -v --cov=app --cov-report=xml

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl unzip
    
    - name: Install Yandex Cloud CLI
      run: |
        echo "ðŸ“¦ Installing Yandex Cloud CLI..."
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc version
    
    - name: Configure Yandex Cloud CLI
      env:
        YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
        YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo "ðŸ” Configuring Yandex Cloud CLI..."
        echo "${{ secrets.YC_SA_JSON_CREDENTIALS }}" > $YC_SERVICE_ACCOUNT_KEY_FILE
        yc config profile create github-actions || true
        yc config set service-account-key $YC_SERVICE_ACCOUNT_KEY_FILE
        yc config set folder-id $YC_FOLDER_ID
    
    - name: Login to Yandex Container Registry
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc container registry configure-docker
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
    
    - name: Install Yandex Cloud CLI
      run: |
        echo "ðŸ“¦ Installing Yandex Cloud CLI..."
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc version
    
    - name: Configure Yandex Cloud CLI
      env:
        YC_SERVICE_ACCOUNT_KEY_FILE: /tmp/yc-sa-key.json
        YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo "ðŸ” Configuring Yandex Cloud CLI..."
        echo "${{ secrets.YC_SA_JSON_CREDENTIALS }}" > $YC_SERVICE_ACCOUNT_KEY_FILE
        yc config profile create github-actions || true
        yc config set service-account-key $YC_SERVICE_ACCOUNT_KEY_FILE
        yc config set folder-id $YC_FOLDER_ID
    
    - name: Deploy to Yandex Cloud Run
      run: |
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc serverless container create --name auth-service --folder-id ${{ secrets.YC_FOLDER_ID }} || true
        
        yc serverless container revision deploy \
          --container-name auth-service \
          --folder-id ${{ secrets.YC_FOLDER_ID }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --service-account-id ${{ secrets.YC_SERVICE_ACCOUNT_ID }} \
          --cores 1 \
          --memory 512MB \
          --execution-timeout 30s \
          --concurrency 10 \
          --environment DATABASE_URL="${{ secrets.DATABASE_URL }}",SECRET_KEY="${{ secrets.SECRET_KEY }}" \
          --min-instances 1 \
          --max-instances 3

